{% extends request.is_ajax|yesno:'nullcont.htm,abonapp/ext.htm' %}
{% load i18n %}
{% load bootstrap3 %}
{% block content %}

    <div class="row">
        <div class="col-sm-12 col-xs-12 col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">{% trans 'Change subscriber' %}</h3>
                </div>
                <div class="panel-body">

                    {% if perms.abonapp.change_abon %}
                        {% url 'abonapp:abon_home' group.pk abon.username as ahlink %}
                    {% endif %}

                    <form autocomplete="off" class="form-horizontal" action="{{ ahlink|default:'#' }}" method="post">{% csrf_token %}

                        {% bootstrap_field form.username form_group_class='form-group-sm' %}
                        {% bootstrap_field form.fio form_group_class='form-group-sm' %}


                        {# telephone field #}
                        {% trans 'Call to' as tx %}
                        {% bootstrap_button '' button_type='link' icon='earphone' button_class='btn-default' title=tx href='sip:'|add:form.telephone.value size='sm' as btn_call %}

                        {% trans 'Additional telephones' as tx %}
                        {% url 'abonapp:telephones' group.pk abon.username as url %}
                        {% bootstrap_button '' button_type='link' icon='list' button_class='btn-default btn-modal' title=tx href=url size='sm' as btn_teleph_list %}

                        {% trans 'Add telephone' as tx %}
                        {% url 'abonapp:telephone_new' group.pk abon.username as url %}
                        {% bootstrap_button '' button_type='link' icon='plus' button_class='btn-default btn-modal' title=tx href=url size='sm' as btn_teleph_add %}

                        {% with ''|add:btn_call|add:btn_teleph_list|add:btn_teleph_add as bt %}
                            {% bootstrap_field form.telephone form_group_class='form-group-sm' addon_after_class='input-group-btn' addon_after=bt %}
                        {% endwith %}


                        {# Ip address field #}
                        {% trans 'Reset ip' as tx %}
                        {% url 'abonapp:reset_ip' group.pk abon.username as url %}
                        {% bootstrap_button '' button_type='link' icon='refresh' button_class='btn-default btn-cmd' id='iprefreshbtn' href=url size='sm' title=tx as bt %}
                        {% bootstrap_field form.ip_address form_group_class='form-group-sm' addon_after_class='input-group-btn' addon_after=bt %}


                        {% bootstrap_field form.street form_group_class='form-group-sm' %}
                        {% bootstrap_field form.house form_group_class='form-group-sm' %}
                        {% bootstrap_field form.is_active form_group_class='form-group-sm' %}
                        {% bootstrap_field form.group form_group_class='form-group-sm' %}


                        {# password field #}
                        {% bootstrap_button '' button_type='button' icon='eye-open' button_class='btn-default' id='passwdtoggler' size='sm' as bt %}
                        {% bootstrap_field form.password form_group_class='form-group-sm' addon_after_class='input-group-btn' addon_after=bt %}


                        <script type="text/javascript">
                            $(function () {
                                $("#iprefreshbtn").on('click', function(){
                                    $("#{{ form.ip_address.id_for_label }}").val('');
                                });
                                $('#passwdtoggler').on('mousedown', function(){
                                    document.getElementById("{{ form.password.id_for_label }}").type='text';
                                }).on('mouseup', function(){
                                    document.getElementById("{{ form.password.id_for_label }}").type='password';
                                });
                            });
                        </script>

                        {% bootstrap_field form.description form_group_class='form-group-sm' %}

                        <div class="form-group-sm">
                            <div class="btn-group btn-group-sm">

                                {% trans 'Save' as tx %}
                                {% if perms.abonapp.change_abon %}
                                    {% bootstrap_button tx button_type='submit' icon='floppy-disk' button_class='btn-primary' %}
                                {% else %}
                                    {% bootstrap_button tx button_type='button' icon='floppy-disk' button_class='btn-primary disabled' %}
                                {% endif %}

                                {% if perms.taskapp.add_task %}
                                    <a href="{% url 'taskapp:add' %}?uid={{ abon.username }}" class="btn btn-success" title="{% trans 'Add new task' %}">
					                    <span class="glyphicon glyphicon-plus"></span>
                                        {% trans 'Add new task' %}
                                    </a>
                                {% else %}
                                    <a href="#" class="btn btn-success disabled" title="{% trans 'Permission denied' %}">
                                        <span class="glyphicon glyphicon-plus"></span>
                                        {% trans 'Add new task' %}
                                    </a>
                                {% endif %}

                                {% if form.ip_address.value %}
                                    {% if perms.abonapp.can_ping %}
                                        <a href="{% url 'abonapp:ping' %}" class="btn btn-default btn-cmd" title="Ping" data-param="{{ form.ip_address.value }}">
                                            <span class="glyphicon glyphicon-flash"></span> Ping
                                        </a>
                                    {% else %}
                                        <a href="#" class="btn btn-default disabled" title="{% trans 'Permission denied' %}">
                                            <span class="glyphicon glyphicon-flash"></span> Ping
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <a href="#" class="btn btn-default disabled">
                                        <span class="glyphicon glyphicon-flash"></span> {% trans 'No have ip' %}
                                    </a>
                                {% endif %}

                                {% if perms.dialing_app.can_send_sms %}
                                    <a href="{% url 'dialapp:send_sms' %}?path={{ request.path|urlencode }}&dst={{ form.telephone.value|urlencode }}" class="btn btn-default btn-modal">
                                        <span class="glyphicon glyphicon-envelope"></span> {% trans 'Send sms' %}
                                    </a>
                                {% else %}
                                    <a href="#" class="btn btn-default disabled" title="{% trans 'Permission denied' %}">
                                        <span class="glyphicon glyphicon-envelope"></span> {% trans 'Send sms' %}
                                    </a>
                                {% endif %}
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-xs-12 col-md-6">
            {% if perms.abonapp.change_abon %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        {% if device %}
                            {% trans 'Device' %}
                        {% else %}
                            {% trans 'Select the device' %}
                        {% endif %}
                    </h3>
                </div>

                <div class="panel-body">
                    <form class="form-horizontal" action="{% url 'abonapp:save_user_dev_port' group.pk abon.username %}" method="post">{% csrf_token %}

                        <div class="form-group-sm">
                        <label for="id_method" class="col-sm-4 control-label">{% trans 'Device' %}</label>
                            <div class="col-sm-8 btn-group btn-group-sm">
                                {% if device %}
                                    <a href="{% url 'devapp:view' group.pk device.pk %}" target="_blank" class="btn btn-sm btn-default" title="{% trans 'Mac Address' %}: {{ device.mac_addr|default:_('Not assigned') }}">
                                        <span class="glyphicon glyphicon-hdd"></span> <span class="hidden-md">{{ device.comment|truncatechars:11 }} {{ device.ip_address }}</span>
                                    </a>
                                    <a href="{% url 'abonapp:clear_dev' group.pk abon.username %}" class="btn btn-sm btn-danger">
					                    <span class="glyphicon glyphicon-remove-circle"></span> <span class="hidden-xs hidden-lg">{% trans 'Remove clutch' %}</span>
                                    </a>
                                {% else %}
                                    <a href="{% url 'abonapp:dev' group.pk abon.username %}" class="btn btn-success btn-sm btn-modal">
                                        <span class="glyphicon glyphicon-plus"></span> {% trans 'Add clutch' %}
                                    </a>
                                {% endif %}
                            </div>
                        </div>

                        {% if device %}
                        <div class="form-group-sm">
                            <label for="id_dev_port" class="col-sm-4 control-label">{% trans 'Device port' %}</label>
                            <div class="col-sm-8">
                                <select id="id_dev_port" class="form-control" name="user_port">
                                    <option value="0">{% trans 'Not assigned' %}</option>
                                    {% for port in dev_ports %}
                                        {% if port == abon.dev_port %}
					                        <option value="{{ port.pk }}" selected>{{ port.num }}: {{ port.descr }}</option>
                                        {% else %}
                                            <option value="{{ port.pk }}">{{ port.num }}: {{ port.descr }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group-sm">
                            <div class="col-sm-offset-4 col-sm-8 checkbox">
                                <label>
                                    <input type="checkbox" name="is_dynamic_ip"{% if abon.is_dynamic_ip %} checked{% endif %}> {% trans 'Is dynamic network settings' %}
                                </label>
                            </div>
                        </div>
                        <div class="form-group-sm">
                            <div class="col-sm-8 col-sm-offset-4">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <span class="glyphicon glyphicon-floppy-disk"></span> {% trans 'Save' %}
			                    </button>
			                </div>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
            {% endif %}
            {% if perms.abonapp.add_extrafieldsmodel %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">{% trans 'Extra fields' %}</h3>
                </div>
                <div class="panel-body">
                    <form class="form-horizontal" action="{% url 'abonapp:extra_field_edit' group.pk abon.username %}" method="post">{% csrf_token %}

                        {% for ef in abon.extra_fields.all %}
                        <div class="form-group-sm">
                            <label class="col-sm-4 control-label">{{ ef.title }}</label>
                            <div class="col-sm-8">

                                <div class="input-group input-group-sm">
                                    <input type="text" value="{{ ef.data|default:_('Not assigned') }}" class="form-control" pattern="{{ ef.get_regexp }}" name="ex">
                                    <input type="hidden" value="{{ ef.pk }}" name="ed">
                                    <span class="input-group-btn">
                                        <a href="{% url 'abonapp:extra_field_delete' group.pk abon.username ef.pk %}" class="btn btn-danger" title="{% trans 'Delete' %}">
                                            <span class="glyphicon glyphicon-remove"></span>
                                        </a>
                                    </span>
                                </div>

                            </div>
                        </div>
                        {% empty %}
                            <h3>{% trans 'Extra field does not exist' %}</h3>
                        {% endfor %}

                        <div class="form-group-sm">
                            <div class="col-sm-offset-4 col-sm-8 btn-group btn-group-sm">
                                <a href="{% url 'abonapp:extra_field' group.pk abon.username %}" class="btn btn-success btn-modal" title="{% trans 'Add extra field' %}">
                                    <span class="glyphicon glyphicon-plus"></span> {% trans 'Add' %}
                                </a>

                                <button class="btn btn-primary" type="submit">
                                    <span class="glyphicon glyphicon-edit"></span> {% trans 'Save' %}
                                </button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
            {% endif %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">{% trans 'User flags' %}</h3>
                </div>
                <div class="panel-body">
                    {% for user_icon in abon.get_flag_icons %}
                    <span class="m-icon {{ user_icon }}"></span>
                    {% endfor %}
                </div>
                <div class="panel-footer">
                    <div class="btn-group">
                        <a href="{% url 'abonapp:markers_edit' group.pk abon.username %}" class="btn btn-default btn-modal">
                            <span class="glyphicon glyphicon-edit"></span> {% trans 'Edit' %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
